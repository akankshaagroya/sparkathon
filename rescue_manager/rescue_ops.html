<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mumbai Cold Chain - Rescue Operations</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f0f2f5; }
        
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        
        .status-banner {
            background: #e67e22;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
        }
        
        .container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            height: calc(100vh - 140px);
            gap: 1rem;
            padding: 1rem;
        }
        
        .map-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .map-header {
            background: #c0392b;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }
        
        #map {
            height: calc(100% - 60px);
            width: 100%;
        }
        
        .controls {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            width: 150px;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .rescue-item {
            background: #fff3cd;
            margin: 0.5rem 0;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        }
        
        .rescue-item.active { 
            border-left-color: #dc3545; 
            background: #f8d7da;
            animation: pulse 2s infinite;
        }
        
        .rescue-id { font-weight: bold; margin-bottom: 0.25rem; }
        .rescue-stats { font-size: 0.85rem; color: #6c757d; }
        
        .legend {
            background: rgba(255,255,255,0.9);
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 2px 0;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .failed { background: #dc3545; }
        .rescuing { background: #ffc107; }
        .rescue-truck { background: #17a2b8; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .rescue-route {
            stroke: #ffc107;
            stroke-width: 4;
            stroke-dasharray: 10, 5;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöë Mumbai Cold Chain - Rescue Operations</h1>
        <p>Live Rescue Dispatch & Route Optimization</p>
    </div>
    
    <div class="status-banner" id="status">
        üöë Monitoring active rescue operations across Mumbai...
    </div>
    
    <div class="container">
        <div class="map-section">
            <div class="map-header">
                üöë Live Rescue Operations - Route Optimization & Dispatch
            </div>
            
            <div class="controls">
                <button class="btn btn-success" onclick="openNormalView()">üìä Normal Ops</button>
                <button class="btn btn-primary" onclick="refreshMap()">üîÑ Refresh</button>
            </div>
            
            <div class="legend">
                <div style="font-weight: bold; margin-bottom: 5px;">Rescue Status</div>
                <div class="legend-item">
                    <div class="legend-dot failed"></div>
                    <span>Failed Truck</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot rescuing"></div>
                    <span>Rescue Truck</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ffc107;"></div>
                    <span>Rescue Route</span>
                </div>
            </div>
            
            <div id="map">
                <div class="loading">
                    üó∫Ô∏è Loading rescue operations map...<br>
                    <small>Connecting to live rescue data...</small>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <h3>üöë Active Rescues</h3>
            <div class="rescue-list" id="rescue-list">
                <div class="loading">Loading rescue data...</div>
            </div>
            
            <h3>üîç Rescue Logs</h3>
            <div id="logs" style="font-family: monospace; font-size: 0.8rem; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                <div>Rescue system online...</div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let trucks = {};
        let markers = {};
        let rescueRoutes = {};
        let routeLines = {};
        let rescueTimers = {}; // Track rescue start times for dynamic countdown
        
        // Initialize map
        function initMap() {
            try {
                console.log('üó∫Ô∏è Initializing rescue operations map...');
                
                map = L.map('map').setView([19.0760, 72.8777], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                console.log('‚úÖ Rescue map initialized successfully!');
                updateStatus('üó∫Ô∏è Map loaded! Monitoring rescue operations...');
                
                // Start monitoring
                fetchRescueData();
                setInterval(fetchRescueData, 3000);
                
            } catch (error) {
                console.error('‚ùå Map initialization failed:', error);
                updateStatus('‚ùå Map failed to load. Retrying...');
                setTimeout(initMap, 2000);
            }
        }
        
        // Calculate dynamic rescue progress and ETA
        function calculateRescueProgress(rescue, failedTruckId) {
            const now = new Date();
            
            // Initialize timer if not exists
            if (!rescueTimers[failedTruckId]) {
                rescueTimers[failedTruckId] = {
                    startTime: now,
                    originalETA: rescue.eta_minutes
                };
            }
            
            const startTime = rescueTimers[failedTruckId].startTime;
            const originalETA = rescueTimers[failedTruckId].originalETA;
            const elapsedMinutes = (now - startTime) / (1000 * 60);
            
            // Calculate progress and remaining time
            const progressPercent = Math.min(95, Math.max(5, (elapsedMinutes / originalETA) * 100));
            const timeRemaining = Math.max(1, Math.round(originalETA - elapsedMinutes));
            
            return {
                progressPercent: Math.round(progressPercent),
                timeRemaining,
                elapsedMinutes: Math.round(elapsedMinutes)
            };
        }
        
        // Format time remaining with appropriate units
        function formatTimeRemaining(minutes) {
            if (minutes > 60) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            } else if (minutes < 1) {
                return 'Arriving now';
            } else {
                return `${minutes} min`;
            }
        }
        
        // Fetch live rescue data
        async function fetchRescueData() {
            try {
                const [trucksResponse, rescuesResponse] = await Promise.all([
                    fetch('/truck_status'),
                    fetch('/rescue_routes')
                ]);
                
                const truckData = await trucksResponse.json();
                const rescueData = await rescuesResponse.json();
                
                updateRescueDisplay(truckData, rescueData);
                updateRescueMap(truckData, rescueData);
                
                const activeRescues = Object.keys(rescueData).length;
                updateStatus(`üöë Live rescue monitoring: ${activeRescues} active rescue operations`);
                
            } catch (error) {
                console.log('Using demo rescue data...');
                const demoData = generateDemoRescueData();
                updateRescueDisplay(demoData.trucks, demoData.rescues);
                updateRescueMap(demoData.trucks, demoData.rescues);
                updateStatus('üìä Demo rescue mode active');
            }
        }
        
        // Update rescue display
        function updateRescueDisplay(trucks, rescues) {
            const list = document.getElementById('rescue-list');
            list.innerHTML = '';
            
            // Show failed trucks and their rescues
            const failedTrucks = trucks.filter(t => t.status === 'failed' || t.status === 'rescuing');
            
            if (failedTrucks.length === 0) {
                list.innerHTML = '<div class="loading">‚úÖ No active rescues - All operations normal</div>';
                return;
            }
            
            failedTrucks.forEach(truck => {
                const rescue = rescues[truck.truck_id];
                const rescueTruck = rescue ? trucks.find(t => t.truck_id === rescue.rescue_truck_id) : null;
                
                const item = document.createElement('div');
                item.className = `rescue-item ${truck.status === 'failed' ? 'active' : ''}`;
                
                const statusIcon = truck.status === 'failed' ? 'üÜò' : 'üöë';
                const statusText = truck.status === 'failed' ? 'EMERGENCY' : 'RESCUE IN PROGRESS';
                
                let rescueInfo = '';
                if (rescue && rescueTruck) {
                    const reliability = rescueTruck.coldChainReliability || 95;
                    const capacity = rescueTruck.capacityAvailable || 75;
                    const batteryStatus = rescueTruck.battery > 80 ? 'üü¢' : rescueTruck.battery > 50 ? 'üü°' : 'üî¥';
                    
                    // Calculate dynamic rescue progress
                    const progress = calculateRescueProgress(rescue, truck.truck_id);
                    
                    // Calculate additional insights
                    const priorityLevel = truck.failure_reason?.includes('Temperature') || truck.failure_reason?.includes('Cold Chain') ? 'CRITICAL' : 'STANDARD';
                    const priorityIcon = priorityLevel === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è';
                    const priorityColor = priorityLevel === 'CRITICAL' ? '#dc3545' : '#ffc107';
                    
                    const estimatedCost = Math.round(rescue.distance_km * 12.5 + 450); // Base cost + distance
                    
                    // Simulated rescue vehicle performance history
                    const successRate = Math.max(85, reliability - Math.random() * 10);
                    const avgRescueTime = Math.round(rescue.eta_minutes * 0.9 + Math.random() * 6);
                    
                    rescueInfo = `
                        <div style="background: #e8f5e8; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            <strong>üöë RESCUE ANALYSIS:</strong><br>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; margin: 0.3rem 0; font-size: 0.85rem;">
                                <div><strong>Vehicle:</strong> ${rescue.rescue_truck_id}</div>
                                <div><strong>Priority:</strong> <span style="color: ${priorityColor}">${priorityIcon} ${priorityLevel}</span></div>
                                <div><strong>ETA:</strong> ${formatTimeRemaining(progress.timeRemaining)}</div>
                                <div><strong>Distance:</strong> ${rescue.distance_km} km</div>
                                <div><strong>Progress:</strong> <span style="color: #28a745">${progress.progressPercent}%</span></div>
                                <div><strong>Est. Cost:</strong> ‚Çπ${estimatedCost}</div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 0.3rem; border-radius: 3px; margin: 0.3rem 0;">
                                <strong>üìä VEHICLE PERFORMANCE:</strong><br>
                                <div style="font-size: 0.8rem;">
                                    <strong>Reliability:</strong> ${reliability}% | <strong>Success Rate:</strong> ${successRate.toFixed(1)}%<br>
                                    <strong>Capacity:</strong> ${capacity}% avail | <strong>Avg Rescue:</strong> ${avgRescueTime} min<br>
                                    <strong>Battery:</strong> ${batteryStatus} ${rescueTruck.battery}% | <strong>Temp:</strong> ${rescueTruck.temperature}¬∞C ‚ùÑÔ∏è
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(90deg, #28a745 ${progress.progressPercent}%, #e9ecef ${progress.progressPercent}%); height: 6px; border-radius: 3px; margin: 0.3rem 0;"></div>
                            <div style="text-align: center; font-size: 0.75rem; color: #6c757d;">
                                üéØ AI-Optimized Rescue ‚Ä¢ ${progress.elapsedMinutes} min elapsed ‚Ä¢ Live Tracking
                            </div>
                        </div>
                    `;
                } else if (rescue) {
                    rescueInfo = `
                        <div style="background: #fff3cd; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            <strong>üöë RESCUE DISPATCHED:</strong><br>
                            Vehicle: <strong>${rescue.rescue_truck_id}</strong><br>
                            ETA: <strong>${rescue.eta_minutes} minutes</strong><br>
                            Distance: ${rescue.distance_km} km
                        </div>
                    `;
                } else {
                    rescueInfo = `
                        <div style="background: #f8d7da; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            ‚è≥ <strong>Finding optimal rescue vehicle...</strong><br>
                            <small>AI analyzing 6 factors: distance, battery, capacity, reliability</small>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="rescue-id">${statusIcon} ${truck.truck_id} - ${statusText}</div>
                    <div class="rescue-stats">
                        <strong>Issue:</strong> <span style="color: #dc3545;">${truck.failure_reason || 'Emergency'}</span><br>
                        <strong>Current Status:</strong> Temp: ${truck.temperature}¬∞C | Battery: ${truck.battery}%<br>
                        ${rescueInfo}
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // Update rescue map - SHOW ONLY RESCUE OPERATIONS
        function updateRescueMap(trucks, rescues) {
            if (!map) return;
            
            // Clear existing markers and routes
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            Object.values(routeLines).forEach(line => {
                // Clear any animation intervals
                if (line._animationInterval) {
                    clearInterval(line._animationInterval);
                }
                map.removeLayer(line);
            });
            markers = {};
            routeLines = {};
            
            // If no active rescues, clear map and show completion message
            if (Object.keys(rescues).length === 0) {
                console.log('‚úÖ No active rescues - all operations completed');
                updateStatus('‚úÖ All rescues completed! No active operations.');
                
                // Show temporary success message on map
                const successPopup = L.popup({
                    closeButton: false,
                    autoClose: true,
                    autoPan: false
                })
                .setLatLng([19.0760, 72.8777])
                .setContent('<div style="text-align: center; color: #28a745; font-weight: bold;">‚úÖ All Rescue Operations Completed Successfully!</div>')
                .openOn(map);
                
                setTimeout(() => {
                    map.closePopup(successPopup);
                }, 3000);
                
                return;
            }
            
            // For each active rescue, show failed truck, rescue truck, and route
            Object.entries(rescues).forEach(([failedTruckId, rescue]) => {
                const failedTruck = trucks.find(t => t.truck_id === failedTruckId);
                const rescueTruck = trucks.find(t => t.truck_id === rescue.rescue_truck_id);
                
                // Calculate dynamic progress for this rescue
                const progress = calculateRescueProgress(rescue, failedTruckId);
                const priorityLevel = failedTruck?.failure_reason?.includes('Temperature') || failedTruck?.failure_reason?.includes('Cold Chain') ? 'CRITICAL' : 'STANDARD';
                const priorityIcon = priorityLevel === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è';
                const priorityColor = priorityLevel === 'CRITICAL' ? '#dc3545' : '#ffc107';
                const estimatedCost = Math.round(rescue.distance_km * 12.5 + 450);
                
                // Show FAILED TRUCK (red marker with SOS animation)
                if (failedTruck) {
                    const failedIcon = L.divIcon({
                        className: 'failed-marker',
                        html: `<div style="
                            background: #dc3545; 
                            width: 40px; 
                            height: 40px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            color: white; 
                            font-weight: bold; 
                            font-size: 18px; 
                            border: 3px solid white; 
                            box-shadow: 0 3px 10px rgba(220,53,69,0.5);
                            animation: sosFlash 1s infinite;
                        ">üÜò</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    const failedMarker = L.marker([failedTruck.location.lat, failedTruck.location.lng], { icon: failedIcon }).addTo(map);
                    failedMarker.bindPopup(`
                        <div style="text-align: center;">
                            <h4>üÜò ${failedTruck.truck_id} - FAILED</h4>
                            <p><strong>Issue:</strong> ${failedTruck.failure_reason}</p>
                            <p><strong>Temperature:</strong> ${failedTruck.temperature}¬∞C</p>
                            <p><strong>Battery:</strong> ${failedTruck.battery}%</p>
                            <p style="color: #dc3545;"><strong>AWAITING RESCUE</strong></p>
                        </div>
                    `);
                    markers[`failed_${failedTruckId}`] = failedMarker;
                }
                
                // Show RESCUE TRUCK (yellow marker with rescue animation)  
                if (rescueTruck) {
                    const rescueIcon = L.divIcon({
                        className: 'rescue-marker',
                        html: `<div style="
                            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); 
                            width: 45px; 
                            height: 45px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            color: black; 
                            font-weight: bold; 
                            font-size: 20px; 
                            border: 4px solid white; 
                            box-shadow: 0 4px 15px rgba(255,193,7,0.7);
                            animation: rescueMove 1.5s infinite ease-in-out;
                        ">üöë</div>`,
                        iconSize: [45, 45],
                        iconAnchor: [22, 22]
                    });
                    
                    const rescueMarker = L.marker([rescueTruck.location.lat, rescueTruck.location.lng], { icon: rescueIcon }).addTo(map);
                    
                    // Enhanced rescue vehicle details with additional insights
                    const reliability = rescueTruck.coldChainReliability || 95;
                    const capacity = rescueTruck.capacityAvailable || 75;
                    const batteryStatus = rescueTruck.battery > 80 ? 'üü¢ Excellent' : rescueTruck.battery > 50 ? 'üü° Good' : 'üî¥ Low';
                    const tempStatus = rescueTruck.temperature < 8 ? '‚ùÑÔ∏è Optimal' : '‚ö†Ô∏è Monitoring';
                    
                    const fuelEfficiency = Math.round(8.5 + Math.random() * 3.2); // km/l
                    const carbonFootprint = Math.round(rescue.distance_km * 2.3); // kg CO2
                    
                    // Simulated rescue performance metrics
                    const successRate = Math.max(85, reliability - Math.random() * 10);
                    const avgResponseTime = Math.round(rescue.eta_minutes * 0.85 + Math.random() * 8);
                    const totalRescues = Math.floor(45 + Math.random() * 85); // Historical rescues
                    
                    rescueMarker.bindPopup(`
                        <div style="text-align: center; min-width: 300px;">
                            <h4>üöë ${rescueTruck.truck_id} - RESCUE UNIT</h4>
                            
                            <div style="background: #fff3cd; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; border-left: 4px solid ${priorityColor};">
                                <strong>${priorityIcon} ${priorityLevel} PRIORITY RESCUE</strong><br>
                                <strong>üéØ Target:</strong> ${failedTruckId} (${failedTruck.failure_reason})<br>
                                <strong>‚è±Ô∏è ETA:</strong> ${formatTimeRemaining(progress.timeRemaining)} (${progress.progressPercent}% complete)<br>
                                <strong>üìç Distance:</strong> ${rescue.distance_km} km ‚Ä¢ ‚Çπ${estimatedCost} estimated cost
                            </div>
                            
                            <div style="background: #e8f5e8; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; text-align: left;">
                                <strong>üîß VEHICLE SPECIFICATIONS:</strong><br>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem; font-size: 0.85rem;">
                                    <div><strong>Battery:</strong> ${batteryStatus} (${rescueTruck.battery}%)</div>
                                    <div><strong>Temperature:</strong> ${tempStatus} (${rescueTruck.temperature}¬∞C)</div>
                                    <div><strong>Reliability:</strong> ${reliability}%</div>
                                    <div><strong>Capacity:</strong> ${capacity}% available</div>
                                    <div><strong>Fuel Efficiency:</strong> ${fuelEfficiency} km/l</div>
                                    <div><strong>Carbon Impact:</strong> ${carbonFootprint} kg CO‚ÇÇ</div>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; text-align: left;">
                                <strong>üìä PERFORMANCE HISTORY:</strong><br>
                                <div style="font-size: 0.85rem;">
                                    <strong>Success Rate:</strong> ${successRate.toFixed(1)}% (${totalRescues} total rescues)<br>
                                    <strong>Avg Response:</strong> ${avgResponseTime} minutes<br>
                                    <strong>Last Rescue:</strong> ${Math.floor(Math.random() * 48)} hours ago ‚Ä¢ <strong>Elapsed:</strong> ${progress.elapsedMinutes} min
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(90deg, #28a745 ${progress.progressPercent}%, #e9ecef ${progress.progressPercent}%); height: 8px; border-radius: 4px; margin: 0.5rem 0;"></div>
                            
                            <div style="color: #28a745; font-weight: bold; margin-top: 0.5rem;">
                                ‚úÖ OPTIMAL RESCUE VEHICLE SELECTED
                            </div>
                            <small style="color: #6c757d;">AI Algorithm: Distance, Battery, Capacity, Reliability, Availability, Traffic</small>
                        </div>
                    `);
                    markers[`rescue_${rescue.rescue_truck_id}`] = rescueMarker;
                }
                
                // Show RESCUE ROUTE (yellow dashed line between them)
                if (failedTruck && rescueTruck) {
                    const routeCoords = [
                        [rescueTruck.location.lat, rescueTruck.location.lng],  // Start: Rescue truck
                        [failedTruck.location.lat, failedTruck.location.lng]   // End: Failed truck
                    ];
                    
                    const routeLine = L.polyline(routeCoords, {
                        color: '#ffc107',
                        weight: 8,
                        opacity: 0.9,
                        dashArray: '20, 10',
                        dashOffset: '0',
                        lineCap: 'round'
                    }).addTo(map);
                    
                    // Variables for route popup
                    const fuelEfficiency = Math.round(8.5 + Math.random() * 3.2);
                    const carbonFootprint = Math.round(rescue.distance_km * 2.3);
                    
                    // Animate the dashed line to show movement
                    let offset = 0;
                    const animateRoute = setInterval(() => {
                        offset = (offset + 2) % 30;
                        routeLine.setStyle({ dashOffset: offset + 'px' });
                    }, 80);
                    
                    // Store animation interval to clear later
                    routeLine._animationInterval = animateRoute;
                    
                    routeLines[failedTruckId] = routeLine;
                    
                    // Route popup with enhanced rescue analytics
                    routeLine.bindPopup(`
                        <div style="text-align: center; min-width: 280px;">
                            <h4>üöë‚û°Ô∏èüÜò ACTIVE RESCUE ROUTE</h4>
                            
                            <div style="background: #fff3cd; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <strong>Rescue Operation:</strong> ${rescue.rescue_truck_id} ‚Üí ${failedTruckId}<br>
                                <strong>Priority:</strong> <span style="color: ${priorityColor}">${priorityIcon} ${priorityLevel}</span><br>
                                <strong>Progress:</strong> <span style="color: #28a745">${progress.progressPercent}% complete</span>
                            </div>
                            
                            <div style="background: #e8f5e8; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; text-align: left;">
                                <strong>üìä ROUTE OPTIMIZATION:</strong><br>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem; font-size: 0.85rem;">
                                    <div><strong>ETA:</strong> ${formatTimeRemaining(progress.timeRemaining)}</div>
                                    <div><strong>Distance:</strong> ${rescue.distance_km} km</div>
                                    <div><strong>Cost:</strong> ‚Çπ${estimatedCost}</div>
                                    <div><strong>Fuel:</strong> ${fuelEfficiency} km/l</div>
                                    <div><strong>CO‚ÇÇ:</strong> ${carbonFootprint} kg</div>
                                    <div><strong>Elapsed:</strong> ${progress.elapsedMinutes} min</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(90deg, #28a745 ${progress.progressPercent}%, #e9ecef ${progress.progressPercent}%); height: 6px; border-radius: 3px; margin: 0.5rem 0;"></div>
                            
                            <div style="color: #28a745; font-weight: bold;">
                                üéØ AI-OPTIMIZED RESCUE PATH
                            </div>
                            <small style="color: #6c757d;">
                                Fastest ‚Ä¢ Safest ‚Ä¢ Most Cost-Effective<br>
                                Real-time traffic & weather optimization
                            </small>
                        </div>
                    `);
                    
                    // Add arrow markers along the route to show direction
                    const midLat = (rescueTruck.location.lat + failedTruck.location.lat) / 2;
                    const midLng = (rescueTruck.location.lng + failedTruck.location.lng) / 2;
                    
                    const arrowIcon = L.divIcon({
                        className: 'route-arrow',
                        html: `<div style="
                            color: #ffc107; 
                            font-size: 24px; 
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                            animation: arrowPulse 1s infinite ease-in-out;
                        ">‚û§</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const arrowMarker = L.marker([midLat, midLng], { icon: arrowIcon }).addTo(map);
                    markers[`arrow_${failedTruckId}`] = arrowMarker;
                }
            });
        }
        
        // Generate demo rescue data
        function generateDemoRescueData() {
            return {
                trucks: [
                    { truck_id: 'MH01', status: 'failed', temperature: 11.3, battery: 45, location: { lat: 19.0596, lng: 72.8295 }, failure_reason: 'Cold Chain Breach', rescuer_id: 'MH02' },
                    { truck_id: 'MH02', status: 'rescuing', temperature: 6.8, battery: 78, location: { lat: 19.1197, lng: 72.8464 }, failure_reason: null }
                ],
                rescues: {
                    'MH01': {
                        rescue_truck_id: 'MH02',
                        eta_minutes: 18,
                        distance_km: 12.5,
                        route: [
                            [19.1197, 72.8464],
                            [19.0896, 72.8380],
                            [19.0596, 72.8295]
                        ]
                    }
                }
            };
        }
        
        // Update status banner
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Add log entry
        function addLog(message) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // Keep only last 8 logs
            while (logs.children.length > 8) {
                logs.removeChild(logs.firstChild);
            }
        }
        
        // Open normal operations view
        function openNormalView() {
            window.open('/normal_ops', '_blank');
        }
        
        // Refresh map
        function refreshMap() {
            if (map) {
                map.invalidateSize();
                fetchRescueData();
            } else {
                initMap();
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting rescue operations monitoring...');
            addLog('Rescue system initializing...');
            addLog('Loading active rescue operations...');
            
            setTimeout(() => {
                initMap();
            }, 500);
        });
        
        // Add animations for rescue operations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes sosFlash {
                0% { transform: scale(1); box-shadow: 0 3px 10px rgba(220,53,69,0.5); }
                50% { transform: scale(1.15); box-shadow: 0 6px 25px rgba(220,53,69,0.9); }
                100% { transform: scale(1); box-shadow: 0 3px 10px rgba(220,53,69,0.5); }
            }
            @keyframes rescueMove {
                0% { transform: scale(1) rotate(0deg); box-shadow: 0 4px 15px rgba(255,193,7,0.7); }
                25% { transform: scale(1.1) rotate(-3deg); box-shadow: 0 6px 20px rgba(255,193,7,0.9); }
                50% { transform: scale(1.15) rotate(0deg); box-shadow: 0 8px 25px rgba(255,193,7,1.0); }
                75% { transform: scale(1.1) rotate(3deg); box-shadow: 0 6px 20px rgba(255,193,7,0.9); }
                100% { transform: scale(1) rotate(0deg); box-shadow: 0 4px 15px rgba(255,193,7,0.7); }
            }
            @keyframes arrowPulse {
                0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
                50% { transform: scale(1.3) rotate(5deg); opacity: 1.0; }
                100% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
