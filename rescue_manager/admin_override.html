<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Override - Mumbai Cold Chain</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 1.5rem; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .container { max-width: 1200px; margin: 2rem auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 2rem; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-bottom: 2rem; }
        .panel { margin-bottom: 2rem; }
        .panel h3 { margin-bottom: 1rem; }
        .panel-controls { display: flex; gap: 1rem; align-items: center; }
        .panel-controls select, .panel-controls button { padding: 0.5rem 1rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; }
        .panel-controls button { background: #222; color: white; border: none; cursor: pointer; font-weight: 600; }
        .panel-controls span { margin-left: 1rem; color: #007bff; }
        .logs { background: #f8f9fa; padding: 1rem; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ†Ô∏è Admin Override Panel</h1>
        <p>Force-assign rescue trucks with full map context</p>
    </div>
    <div class="container">
        <div id="map"></div>
        <div class="panel">
            <h3>Override Rescue Assignment</h3>
            <div class="panel-controls">
                <select id="failedTruckSelect">
                    <option value="">Select Failed Truck</option>
                </select>
                <select id="rescueTruckSelect">
                    <option value="">Select Rescue Truck</option>
                </select>
                <button id="forceAssignBtn">Force Assign</button>
                <span id="overrideStatus"></span>
            </div>
        </div>
        <h3>System Logs</h3>
        <div class="logs" id="logs">Loading system logs...</div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Map setup (reuse from normal_ops)
        let map;
        async function initMap() {
            map = L.map('map').setView([19.0760, 72.8777], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            await plotTrucks();
        }
        async function plotTrucks() {
            const response = await fetch('/truck_status');
            const trucks = await response.json();
            trucks.forEach(truck => {
                let color = truck.status === 'failed' ? 'red' : (truck.status === 'operational' ? 'green' : 'orange');
                let marker = L.circleMarker([truck.location.lat, truck.location.lng], {
                    radius: 10,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8
                }).addTo(map);
                marker.bindPopup(`<b>${truck.truck_id}</b><br>Status: ${truck.status}<br>Temp: ${truck.temperature}¬∞C<br>Battery: ${truck.battery}%`);
            });
        }
        // Admin Override Panel logic
        async function populateTruckDropdowns() {
            try {
                const response = await fetch('/truck_status');
                const trucks = await response.json();
                const failedSelect = document.getElementById('failedTruckSelect');
                const rescueSelect = document.getElementById('rescueTruckSelect');
                failedSelect.innerHTML = '<option value="">Select Failed Truck</option>';
                rescueSelect.innerHTML = '<option value="">Select Rescue Truck</option>';
                trucks.forEach(truck => {
                    if (truck.status === 'failed') {
                        failedSelect.innerHTML += `<option value="${truck.truck_id}">${truck.truck_id}</option>`;
                    } else if (truck.status === 'operational') {
                        rescueSelect.innerHTML += `<option value="${truck.truck_id}">${truck.truck_id}</option>`;
                    }
                });
            } catch (error) {}
        }
        document.getElementById('forceAssignBtn').onclick = async function() {
            const failedTruck = document.getElementById('failedTruckSelect').value;
            const rescueTruck = document.getElementById('rescueTruckSelect').value;
            const statusSpan = document.getElementById('overrideStatus');
            if (!failedTruck || !rescueTruck) {
                statusSpan.textContent = 'Please select both trucks.';
                statusSpan.style.color = 'red';
                return;
            }
            statusSpan.textContent = 'Processing...';
            statusSpan.style.color = '#007bff';
            try {
                const response = await fetch('/admin_override', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ failed_truck_id: failedTruck, rescue_truck_id: rescueTruck })
                });
                const data = await response.json();
                if (data.success) {
                    statusSpan.textContent = 'Override successful!';
                    statusSpan.style.color = 'green';
                    setTimeout(fetchLogs, 1000);
                    setTimeout(populateTruckDropdowns, 1000);
                    setTimeout(() => { map.remove(); initMap(); }, 1200);
                } else {
                    statusSpan.textContent = data.message || 'Override failed.';
                    statusSpan.style.color = 'red';
                }
            } catch (error) {
                statusSpan.textContent = 'Error sending override.';
                statusSpan.style.color = 'red';
            }
        };
        // System logs
        async function fetchLogs() {
            try {
                const response = await fetch('/system_logs');
                const data = await response.json();
                const logsDiv = document.getElementById('logs');
                logsDiv.innerHTML = data.logs.map(log => `<div>${log}</div>`).join('');
                logsDiv.scrollTop = logsDiv.scrollHeight;
            } catch (error) {
                document.getElementById('logs').innerHTML = '<div>Error loading logs</div>';
            }
        }
        // Init
        initMap();
        populateTruckDropdowns();
        fetchLogs();
        setInterval(populateTruckDropdowns, 5000);
        setInterval(fetchLogs, 3000);
    </script>
</body>
</html> 